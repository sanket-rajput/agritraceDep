rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection: only the user (or an agent) can read or modify a user's profile
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow users to create their own profile; ensure uid matches auth
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.uid == request.auth.uid;

      // Allow owners to update their profile; allow agents to update roles
      allow update: if request.auth != null && (
                      request.auth.uid == userId ||
                      (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent')
                    );

      // No direct deletes allowed (agents should set inactive flag instead)
      allow delete: if false;
    }

    // Waste reports: created by authenticated farmers; readable by owner and agents
    match /wasteReports/{reportId} {
      allow create: if request.auth != null && request.resource.data.farmerId == request.auth.uid;

      allow read: if request.auth != null && (
                    resource.data.farmerId == request.auth.uid ||
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent')
                  );

      // Updates allowed only for agents (e.g., changing status). Farmers cannot change status.
      allow update: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent');

      // Deletions only by agents
      allow delete: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent');
    }

    // Listings: public within authenticated users. Owners can create/update/delete their own listings; agents may moderate.
    match /listings/{listingId} {
      // Anyone authenticated can read listings
      allow read: if request.auth != null;

      // Create if authenticated and ownerId matches auth.uid
      allow create: if request.auth != null
                    && request.resource.data.ownerId == request.auth.uid
                    && request.resource.data.title is string
                    && request.resource.data.price is number
                    && request.resource.data.location is string;

      // Owners can update their own listing; agents can update/delete
      allow update: if request.auth != null && (
                      request.auth.uid == resource.data.ownerId ||
                      (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent')
                    );

      allow delete: if request.auth != null && (
                      request.auth.uid == resource.data.ownerId ||
                      (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent')
                    );
    }

    // Orders: buyers create orders; buyer/seller/agent can read; updates limited to agent or buyer
    match /orders/{orderId} {
      // Create: buyer must be authenticated and match
      allow create: if request.auth != null
                    && request.resource.data.buyerId == request.auth.uid
                    && request.resource.data.listingId is string
                    && request.resource.data.price is number;

      // Read: buyer, seller (owner of listing), or agent
      allow read: if request.auth != null && (
                    resource.data.buyerId == request.auth.uid ||
                    resource.data.sellerId == request.auth.uid ||
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent')
                  );

      // Update: buyer (e.g., cancel) or agent
      allow update: if request.auth != null && (
                      request.auth.uid == resource.data.buyerId ||
                      (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent')
                    );

      // Deletion is not allowed
      allow delete: if false;
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
